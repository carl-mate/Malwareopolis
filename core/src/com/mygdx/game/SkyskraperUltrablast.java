package com.mygdx.game;

import com.badlogic.gdx.Gdx;
import com.badlogic.gdx.scenes.scene2d.Stage;
import com.badlogic.gdx.scenes.scene2d.actions.Actions;

public class SkyskraperUltrablast extends BaseArtillery{
    public static final String TAG = SkyskraperUltrablast.class.getName();

    private final float CD = 2.0f;
    private float shootingCooldownTime = 0.0f;
    private boolean hasBullet = true;
    private Bullet bullet1 = null;
    private Bullet bullet2 = null;

    public SkyskraperUltrablast(float x, float y, Stage s) {
        super(x, y, s);
        String[] filenames = {"skyskraper-ultrablast-1.png", "skyskraper-ultrablast-2.png","skyskraper-ultrablast-3.png"};
        loadAnimationFromFiles(filenames);
    }

    private boolean checkEnemy() {
        for ( BaseActor zombie : BaseActor.getAliveList(this.getStage(), "com.mygdx.game.BaseMinion") ) {
            if (zombie.getRow() == this.getRow()) {
                return true;
            }
        }
        return false;
    }

    protected Bullet makeBullet(){
        return new Bullet(0, 0, this.getStage());
    }

    private void onFire(float dt) {
        if (hasDropTarget())
            shootingCooldownTime -= dt;

        if (shootingCooldownTime < 0 && hasBullet && checkEnemy()) {
//            attackSound.play(0.4f, 1.5f, 0.0f);
            bullet1 = makeBullet();
            bullet1.centerAtActor(new BaseActor(this.getCenterX() + this.getWidth() / 4,
                        this.getCenterY() + this.getHeight()/4, this.getStage()));
            bullet1.setGrid(this.getRow(), this.getCol());

            bullet2 = makeBullet();
            bullet2.centerAtActor(new BaseActor((this.getCenterX() + this.getWidth() / 4) + 50,
                        this.getCenterY() + this.getHeight()/4, this.getStage()));
            bullet2.setGrid(this.getRow(), this.getCol());

            shootingCooldownTime = CD;
            hasBullet = false;
        }
        else {
            if (bullet1 != null && bullet2 != null) {
                if (! checkExistenceOfBullet()) {
                    bullet1.clearActions();
                    bullet1.addAction(Actions.fadeOut(0.1f));
                    bullet1.addAction(Actions.after(Actions.removeActor()));
                    bullet1 = null;

                    bullet2.clearActions();
                    bullet2.addAction(Actions.fadeOut(0.1f));
                    bullet2.addAction(Actions.after(Actions.removeActor()));
                    bullet2 = null;
                    hasBullet = true;
                }
            }
        }
    }

    private boolean checkExistenceOfBullet() {
        if (bullet1.getX() > 800 && bullet2.getX() > 800) return false;
        for (BaseActor minion: BaseActor.getAliveList(this.getStage(), "com.mygdx.game.BaseMinion")) {
            if (bullet1.getRow() == minion.getRow() && bullet1.getRow() != -1 && bullet1.overlaps(minion)){
                ((BaseMinion) minion).hitByBullet(bullet1);
                return false;
            }
            if (bullet2.getRow() == minion.getRow() && bullet2.getRow() != -1 && bullet2.overlaps(minion)){
                ((BaseMinion) minion).hitByBullet(bullet2);
                return false;
            }
        }
        return true;
    }

    @Override
    public void act(float dt) {
        super.act(dt);
        onFire(dt);
    }
}
